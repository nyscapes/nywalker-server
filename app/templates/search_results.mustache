<h3>Results for “{{search_term}}”</h3>
<div style="height: 200px;" id="resultsMap"></div>
<div id="resultsDiv">
  {{#results_table}}
    <table class="table table-hover">
      <tbody>
        {{#results}}
          <tr>
            <td>
              <button class="button btn-primary btn-xs"
                onclick="map.removeLayer(firstHitMarker);recenterMap(L.latLng({{lat}}, {{lon}}));">Map</button>
            </td>
            <td>
              {{name}} <small>({{lat}}, {{lon}})</small><br />
              <small>{{description}}</small>
            </td>
            <td>
              <button class="button btn-primary btn-xs"
                onclick="fillInPlaceData('{{escaped_name}}##{{lat}}##{{lon}}##{{geonameid}}##{{bbox}}##GeoNames##3');">Use</button>
            </td>
          </tr>
        {{/results}}
      </tbody>
    </table>
    <script>
      var firstHit = L.latLng({{first_lat}}, {{first_lon}});
      var map = L.map('resultsMap').setView(firstHit, 12);
      var baseLayer = L.tileLayer.provider('OpenStreetMap.Mapnik').addTo(map);
      var firstHitMarker = L.marker(firstHit).setOpacity(70).addTo(map);

      function fillInPlaceData(data){
        // `data` is a string that looks like "name##lat##lon##geonameid##bbox##source##confidence"
        var array = data.split("##");
        $.each(['#inputName', '#inputLat', '#inputLon', '#inputGeonameid', '#inputBbox', '#inputSource', '#inputConfidence'], function( index, value ){
          $(value).val(
            array[index]
          );
        });
        what3words.positionToWords([array[1], array[2]], function(words){
          $('#inputW3W').val(words.join("."));
        });
      }
    </script>

    <p>&nbsp;</p>
    <p>Nothing fits? Try:</p>
      <ul>
        <li>
          <a target="_blank"
            href="https://en.wikipedia.org/w/index.php?search={{search_term}}">
            Searching <em>Wikipedia</em> 
            <span class='glyphicon glyphicon-new-window'
              aria-hidden='true'></span>
          </a>
        </li>
        <li>
          <button class="btn btn-sm btn-primary" id="searchGoogleMapsButton" type="submit">Asking Google Maps</button>
        </li>
        <li>Adding it manually by clicking on the map. <strong>This is a last resort!</strong></li>
      </ul>

  {{/results_table}}
  {{^results_table}}
   {{> partials/manual_map}}
  {{/results_table}}
  <script>
    var marker = L.marker([0, 0]).setOpacity(0).addTo(map);
    var w = new L.Control.w3w();
    $('.leaflet-container').css('cursor', 'crosshair');
    w.addTo(map);
    map.on('click', function(e) {
      w.setCoordinates(e);
      $('#inputConfidence').val("2");
      $('#inputSource').val("what3words");
      setTimeout(function() {
        // It takes a moment for w to fire up.
        var words = w._locationText.dataset.words.replace(/ /g, ".");
        $('#inputW3W').val(words);
        what3words.wordsToPosition(words, function(coords){
          $('#inputLat').val(coords[0]);
          $('#inputLon').val(coords[1]);
          recenterMap(L.latLng(Number(coords[0]), Number(coords[1])));
        });
      }, 1000);
    });

    $('#inputLon').change(function(){
      var lat = Number($('#inputLat').val());
      var lon = Number($('#inputLon').val());
      if(lat != 0){
        recenterMap(L.latLng(lat, Number($('#inputLon').val())));
      }
    });

    $('#searchGoogleMapsButton').click(function() {
      var url = "http://maps.google.com/maps/api/geocode/json?address={{search_term}}";
      var results = $.getJSON(url);
      setTimeout(function(){
      var searchResult = results.responseJSON.results[0];
      $('#inputName').val(searchResult.formatted_address);
      $('#inputLat').val(searchResult.geometry.location.lat);
      $('#inputLon').val(searchResult.geometry.location.lng);
      $('#inputSource').val("Google Maps");
      recenterMap([searchResult.geometry.location.lat, searchResult.geometry.location.lng]);
      }, 1000);
    });
  </script>
</div>

